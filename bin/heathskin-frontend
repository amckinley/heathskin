#!/usr/bin/env python

import argparse
import sys

import logging
from logging import StreamHandler, Formatter

from heathskin.frontend import app


def main():
    logger = app.logger
    logger.setLevel(logging.INFO)

    parser = argparse.ArgumentParser(description='Track some skins')
    parser.add_argument('--port-offset')
    parser.add_argument('--debug', action='store_true')
    parser.add_argument('--bind-addr', default="127.0.0.1")
    args = parser.parse_args()

    port = 3000
    if args.port_offset:
        port += int(args.port_offset)

    bind_addr = args.bind_addr

    # make flask app's logger behave reasonably and write to stdout
    handler = StreamHandler()
    handler.setLevel(logging.INFO)
    FORMAT_STRING = "{pid=%(process)d} %(asctime)s %(levelname)s [%(filename)s:%(lineno)d] %(message)s"  # noqa
    fmtr = Formatter(fmt=FORMAT_STRING)
    handler.setFormatter(fmtr)
    app.logger.addHandler(handler)

    # SHUT THE FUCK UP
    log = logging.getLogger('werkzeug')
    log.setLevel(logging.ERROR)

    try:
        logger.info("Starting server on %s:%s...", bind_addr, port)
        app.run(port=port, host=bind_addr)
    except Exception:
        logger.error("lol crashing")
        sys.exit(-1)

if __name__ == '__main__':
    main()
