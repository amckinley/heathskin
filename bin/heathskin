#!/usr/bin/env python

import threading
import Queue
import subprocess
import time
import argparse
import logging
log_fmt = "%(asctime)s %(levelname)s [%(filename)s:%(lineno)d] %(message)s"
logging.basicConfig(level=logging.INFO, format=log_fmt)

# XXX: stupid hack to make piping of utf-8 stdout work correctly. this might break
# everything: http://stackoverflow.com/a/17628350
import sys
reload(sys)  # Reload does the trick!
sys.setdefaultencoding('UTF8')

from os.path import expanduser

from heathskin.game_state import GameState
from heathskin.deck import deck_from_file



my_log_path = "./game_log.txt"



class TailThread(threading.Thread):
    def __init__(self, hs_log_path, stop_flag, queue):
        threading.Thread.__init__(self)
        self.daemon = False

        self.logger = logging.getLogger()
        self.hs_log_path = hs_log_path
        self.queue = queue
        self.stop_flag = stop_flag

        self.process = None

    def run(self):
        self.logger.info("Starting log tailer at path %s", self.hs_log_path)
        self.process = subprocess.Popen(
            ["tail", "-f", self.hs_log_path], stdout=subprocess.PIPE)

        try:
            while True:
                if self.stop_flag.is_set():
                    self.shutdown()
                    return

                self.poll_for_output()

        except Exception, e:
            self.logger.exception(e)
            self.shutdown()

    def poll_for_output(self):
        line = self.process.stdout.readline()

        if len(line) > 3 and not line.startswith('('):
            self.queue.put(line)

    def shutdown(self):
        self.logger.info("Shutting down log tailer...")
        self.process.kill()
        self.process.wait()
        self.logger.info("Log tailer shutdown")

def run(args):
    my_log = open(my_log_path, "w")
    d = deck_from_file("data/decks/rage_mage.deck")
    gs = GameState(friendly_deck=d)
    logger = logging.getLogger()

    def shutdown():
        stopper.set()
        t.join()

    try:
        if args.dev:
            fake_lines = open("data/trans_log2.txt")
            for l in fake_lines.readlines():
                gs.feed_line(l.rstrip())
            return

        stopper = threading.Event()
        output_queue = Queue.Queue(maxsize=10) # buffer at most 100 lines
        t = TailThread(args.log_file_path, stopper, output_queue)
        t.start()

        while True:
            try:
                line = output_queue.get_nowait()
            except Queue.Empty:
                continue

            #line = output_queue.get() # blocks
            my_log.write(line)

            if "m_currentTaskList" in line:
                continue

            if "TRANSITIONING" not in line:
                continue

            gs.feed_line(line.rstrip())
            #print tailq.get_nowait() # throws Queue.Empty if there are no lines to read
    except KeyboardInterrupt:
        logger.error("Got SIGINT, shutting down")
        shutdown()

def main(args):
    run(args)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Track some skins')
    parser.add_argument('--dev', action="store_true", default=False)
    default_log_location = expanduser("~/Library/Logs/Unity/Player.log")
    parser.add_argument('--log_file_path', default=default_log_location)
    args = parser.parse_args()

    main(args)
